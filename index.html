<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f5f5, #e8f5e9);
      text-align: center;
      direction: rtl;
      padding: 20px;
      color: #2e7d32;
      position: relative;
      margin: 0;
    }
    
    .ayah-text {
      font-family: 'Amiri Quran', serif;
      font-size: 28px;
      font-weight: bold;
      line-height: 1.8;
      background-color: #fffde7;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      color: #3a2c0b;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border: 1px solid #d4b170;
    }
    
    .question-text {
      font-family: 'Tajawal', sans-serif;
      font-size: 22px;
      margin-bottom: 15px;
      color: #2e7d32;
      font-weight: bold;
    }

    #instructionsBtn {
      position: fixed; 
      top: 10px; 
      left: 10px; 
      z-index: 999;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #4CAF50; 
      color: white; 
      border: none; 
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #instructionsPage {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: #fff; z-index: 1000;
      overflow-y: auto;
      padding: 40px;
      box-sizing: border-box;
    }
    
    #instructionsPage h2 {
      text-align: center;
      color: #2e7d32;
    }
    
    #instructionsPage p {
      font-size: 18px;
      line-height: 1.6;
    }
    
    #instructionsPage button {
      margin-top: 20px;
      padding: 10px 20px; 
      border-radius: 8px;
      background-color: #2196F3; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: bold;
    }
    
    .quiz-box {
      background: #d1ede7;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 600px;
      margin: 20px auto;
    }
    
    h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #2e7d32;
    }
    
    input, select, button {
      width: 80%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 10px;
      border: 2px solid #a5d6a7;
      font-family: 'Tajawal', sans-serif;
      box-sizing: border-box;
    }
    
    button.option-btn {
      display: block;
      background-color: #d1ede7;
      border: 2px solid #2196F3;
      color: #2196F3;
      font-weight: bold;
      transition: 0.3s ease;
      margin: 8px auto;
      padding: 12px;
    }
    
    button.option-btn:hover {
      background-color: #e3f2fd;
    }
    
    .correct {
      background-color: #c8e6c9 !important;
      border-color: #2e7d32 !important;
      color: #2e7d32 !important;
    }
    
    .wrong {
      background-color: #ffcdd2 !important;
      border-color: #c62828 !important;
      color: #c62828 !important;
    }
    
    .answer-feedback {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      border-radius: 8px;
    }
    
    .timer-container {
      font-size: 20px;
      color: #d32f2f;
      font-weight: bold;
      margin: 10px 0;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 10px;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background-color: #4caf50;
      width: 100%;
      transition: width 1s linear;
    }
    
    .time-per-question {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .result-box {
      background-color: #f8f5ee;
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }
    
    .corrections-box {
      margin-top: 20px;
      text-align: right;
      background-color: #d99cb8;
      padding: 15px;
      border-radius: 10px;
    }
    
    .correction-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed #ccc;
    }
    
    .correction-question {
      font-weight: bold;
      color: #333;
    }
    
    .user-answer {
      color: #c62828;
    }
    
    .correct-answer {
      color: #2e7d32;
    }
    
    #nextMode {
      display: none;
    }
    
    .contact-box {
      background-color: #f5f5f5;
      padding: 20px;
      border-radius: 15px;
      margin-top: 30px;
      text-align: center;
    }
    
    .telegram-link {
      display: inline-flex;
      align-items: center;
      background-color: #0088cc;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      margin-top: 10px;
      transition: all 0.3s;
    }
    
    .telegram-link:hover {
      background-color: #006699;
    }
    
    .telegram-link img {
      width: 24px;
      height: 24px;
      margin-left: 10px;
    }
    
    .welcome-message {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 16px;
      text-align: center;
      border: 1px solid #d4b170;
    }
    
    .welcome-title {
      font-weight: bold;
      color: #2e7d32;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .welcome-text {
      line-height: 1.6;
    }
    
    .user-info-box {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
</style>
</head>
<body>
<!-- Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
<button id="instructionsBtn">ØŸ</button>

<!-- ØµÙØ­Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
<div id="instructionsPage">
<h2>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
<p>
Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡
</p>
<p>Ø§Ø®ØªØ¨Ø± Ø­ÙØ¸Ùƒ Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ù…Ù† Ø®Ù„Ø§Ù„ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©</p>
<p>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</p>
<ol>
<li>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¢ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</li>
<li>Ø§Ø®ØªØ± Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©</li>
<li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</li>
</ol>
<p>Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ù†Ø´Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØªØµØ­ÙŠØ­Ø§ØªÙ‡Ø§: https://t.me/qurantest2</p>
<button id="backBtn">Ø±Ø¬ÙˆØ¹</button>
</div>

<div class="quiz-box" id="startForm">
<div class="welcome-message">
  <div class="welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</div>
  <div class="welcome-text">
    Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸Ùƒ Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ù…Ù† Ø®Ù„Ø§Ù„ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©.
    Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†!
  </div>
</div>
<h2>Ø§Ø¨Ø¯Ø£ Ø§Ø®ØªØ¨Ø§Ø±Ùƒ</h2>
<input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required />
<input type="number" id="questionCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 25)" min="1" max="25" value="" required />
<select id="surahSelector" required>
<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© --</option>
</select>
<button onclick="startQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
</div>

<div class="quiz-box" id="quizBox" style="display: none;">
<div class="user-info-box">
  <p style="margin: 5px 0;">
    <span style="font-weight: bold;">Ø§Ù„Ø§Ø³Ù…:</span> 
    <span id="userNameDisplay">Ø²Ø§Ø¦Ø±</span>
  </p>
</div>

<div class="timer-container">
<div id="timer">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 00:00</div>
<div class="time-per-question" id="timePerQuestion">60 Ø«Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„</div>
<div class="progress-bar">
<div class="progress" id="progress"></div>
</div>
</div>
<div id="currentAyah">
<!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¢ÙŠØ© Ù‡Ù†Ø§ -->
</div>
<div id="nextMode">
<div id="choices"></div>
</div>
<p class="answer-feedback" id="feedback"></p>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
const TELEGRAM_BOT_TOKEN = '6671455687:AAHemRdgQbmodCsqeIaha55qfPml_h9cjVQ';
const TELEGRAM_CHANNEL_ID = '@quranmytest';
const TELEGRAM_SECOND_CHANNEL_ID = '@qurantest2';

const sheetURLs = {
  next: "https://opensheet.elk.sh/1opUbpiRngFk8tJVqt-jffAkr27kI9CwpAdd7QnOFsK4/next",
  results: 'https://sheet.best/api/sheets/2fb79a9a-4f21-483d-9446-3f0dc5fe9c7c/tabs/result',
  corrections: 'https://sheet.best/api/sheets/2fb79a9a-4f21-483d-9446-3f0dc5fe9c7c/tabs/corrections'
};

const TIME_PER_QUESTION = 60;
const MAX_QUESTIONS = 25;
const TOTAL_SCORE = 100;

let questions = [];
let currentIndex = 0;
let score = 0;
let username = "";
let selectedSurah = "";
let userAnswers = [];
let feedbackList = [];
let timer;
let totalSeconds = 0;
let remainingSeconds = 0;
let testStarted = false;
let corrections = [];

const surahOrder = [
  "Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³",
  "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬",
  "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨",
  "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù",
  "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©",
  "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©",
  "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³",
  "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯",
  "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©",
  "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ",
  "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"
];

async function sendTelegramMessage(text, chatId = TELEGRAM_CHANNEL_ID) {
  try {
    const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: text,
        parse_mode: 'HTML'
      })
    });
    return await response.json();
  } catch (error) {
    console.error('Error sending to Telegram:', error);
    return null;
  }
}

async function sendFinalReport() {
  const percentage = Math.round((score / questions.length) * 100);
  const roundedScore = Math.round((100 / questions.length) * score);
  const now = new Date();
  
  const dateTime = now.toLocaleString('ar-EG', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });

  const basicReport = `
ğŸ“ <b>ØªÙ‚Ø±ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ <b>Ø§Ù„Ø§Ø³Ù…:</b> ${username}
ğŸ“… <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${dateTime}
${selectedSurah && selectedSurah !== "__all__" ? `ğŸ“– <b>Ø§Ù„Ø³ÙˆØ±Ø©:</b> ${selectedSurah}\n` : ''}
ğŸ“Œ <b>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</b> ${questions.length}
âœ… <b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> ${score}
âŒ <b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:</b> ${questions.length - score}
ğŸ“ˆ <b>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©:</b> ${percentage}%
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  `;

  await sendTelegramMessage(basicReport, TELEGRAM_CHANNEL_ID);

  if (corrections.length > 0) {
    let detailedReport = `
ğŸ“ <b>ØªÙ‚Ø±ÙŠØ± ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${dateTime}
${selectedSurah && selectedSurah !== "__all__" ? `ğŸ“– <b>Ø§Ù„Ø³ÙˆØ±Ø©:</b> ${selectedSurah}\n` : ''}
ğŸ“Œ <b>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</b> ${questions.length}
âœ… <b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> ${score}
âŒ <b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:</b> ${questions.length - score}
ğŸ“ˆ <b>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©:</b> ${percentage}%
ğŸ† <b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</b> ${roundedScore}/100
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

    corrections.forEach((correction, index) => {
      detailedReport += `
ğŸ”¹ <b>Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</b> 
ï´¾${correction.question}ï´¿
âœ– <b>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</b> 
ï´¾${correction.userAnswer}ï´¿
âœ” <b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> 
ï´¾${correction.correctAnswer}ï´¿
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
    });

    detailedReport += `
ğŸ“¢ <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b>
ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¦Ùƒ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.
Ø´Ø§Ø±Ùƒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ: https://usamekesmo.github.io/Qurantest/
`;

    await sendTelegramMessage(detailedReport, TELEGRAM_SECOND_CHANNEL_ID);
  }
}

function shuffleArray(array) {
  return array.sort(() => Math.random() - 0.5);
}

function startTimer() {
  updateTimerDisplay();
  timer = setInterval(() => {
    remainingSeconds--;
    updateTimerDisplay();
    if (remainingSeconds <= 0) {
      endTest();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(remainingSeconds / 60);
  const seconds = remainingSeconds % 60;
  const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  document.getElementById("timer").textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formattedTime}`;
  const progressPercent = (remainingSeconds / totalSeconds) * 100;
  document.getElementById("progress").style.width = `${progressPercent}%`;
  if (progressPercent < 20) {
    document.getElementById("progress").style.backgroundColor = "#f44336";
  } else if (progressPercent < 50) {
    document.getElementById("progress").style.backgroundColor = "#ff9800";
  }
}

function endTest() {
  clearInterval(timer);
  showFinalResults();
}

function showFinalResults() {
  clearInterval(timer);
  sendFinalReport();
  
  const percentage = Math.round((score / questions.length) * 100);
  const roundedScore = Math.round((TOTAL_SCORE / questions.length) * score);
  let resultMessage = "";
  if (percentage >= 90) resultMessage = "Ù…Ù…ØªØ§Ø²! Ø­ÙØ¸Ùƒ Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹";
  else if (percentage >= 70) resultMessage = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…";
  else if (percentage >= 50) resultMessage = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡";
  else resultMessage = "ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";

  let reviewItems = "";
  questions.forEach((q, index) => {
    const userAnswer = userAnswers[index] || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©";
    const correctAnswer = q['option' + q['correct option number']];
    reviewItems += `
      <div class="correction-item">
        <div class="correction-question">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù€: ${q.ayanext}</div>
        <div><span class="answer-label">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span> <span class="user-answer">${userAnswer}</span></div>
        <div><span class="answer-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</span> <span class="correct-answer">${correctAnswer}</span></div>
      </div>
    `;
  });

  const resultHTML = `
    <div id="printable-result">
      <h2>Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©</h2>
      <div class="result-box">
        <p style="font-size: 24px; color: #2e7d32;">${resultMessage}</p>
        <p style="font-size: 20px;"><strong>${username}</strong></p>
        <p style="font-size: 20px;">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <strong>${roundedScore}/${TOTAL_SCORE}</strong></p>
        <p>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: <strong>${score}/${questions.length}</strong></p>
        <p>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: <strong>${percentage}%</strong></p>
        ${selectedSurah && selectedSurah !== "__all__" ? `<p>Ø§Ù„Ø³ÙˆØ±Ø©: <strong>${selectedSurah}</strong></p>` : ''}
        <div class="contact-box">
          <h3>Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª</h3>
          <p>Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§ØªÙ†Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…:</p>
          <a href="https://t.me/qurantest2" target="_blank" class="telegram-link">
            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram">
            t.me/qurantest2
          </a>
        </div>
        <div class="corrections-box">
          <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h3>
          ${reviewItems}
        </div>
      </div>
    </div>
  `;
  document.getElementById("quizBox").innerHTML = resultHTML;
  storeResultInSheet();
}

function loadSurahs() {
  fetch(sheetURLs.next)
    .then(res => res.json())
    .then(data => {
      const uniqueSurahs = [...new Set(data.map(q => q.surah?.trim()))];
      const sortedSurahs = surahOrder.filter(s => uniqueSurahs.includes(s));
      const select = document.getElementById("surahSelector");
      const allOption = document.createElement("option");
      allOption.value = "__all__";
      allOption.textContent = "ÙƒÙ„ Ø§Ù„Ø³ÙˆØ±";
      select.appendChild(allOption);
      sortedSurahs.forEach(surah => {
        const option = document.createElement("option");
        option.value = surah;
        option.textContent = surah;
        select.appendChild(option);
      });
    });
}

function startQuiz() {
  username = document.getElementById("username").value.trim();
  selectedSurah = document.getElementById("surahSelector").value;
  const questionCount = parseInt(document.getElementById("questionCount").value) || 10;

  if (!username || !selectedSurah) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }

  document.getElementById("userNameDisplay").textContent = username || "Ø²Ø§Ø¦Ø±";

  currentIndex = 0;
  score = 0;
  questions = [];
  userAnswers = [];
  feedbackList = [];
  corrections = [];
  testStarted = false;

  totalSeconds = Math.min(questionCount, MAX_QUESTIONS) * TIME_PER_QUESTION;
  remainingSeconds = totalSeconds;

  document.getElementById("timePerQuestion").textContent = 
    `${TIME_PER_QUESTION} Ø«Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ (Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒÙ„ÙŠ: ${Math.floor(totalSeconds/60)}:${(totalSeconds%60).toString().padStart(2, '0')})`;

  document.getElementById("startForm").style.display = "none";
  document.getElementById("quizBox").style.display = "block";

  fetch(sheetURLs.next)
    .then(res => res.json())
    .then(data => {
      let filtered = data;
      if (selectedSurah && selectedSurah !== "__all__") {
        filtered = data.filter(q => q.surah?.trim() === selectedSurah.trim());
      }
      const count = Math.min(questionCount, MAX_QUESTIONS);
      questions = shuffleArray(filtered).slice(0, count);
      startTimer();
      showQuestion();
    });
}

function showQuestion() {
  if (!testStarted) {
    testStarted = true;
  }

  document.getElementById('feedback').innerText = "";
  if (currentIndex >= questions.length) {
    clearInterval(timer);
    showFinalResults();
    return;
  }

  const q = questions[currentIndex];
  document.getElementById("nextMode").style.display = "block";

  document.getElementById("currentAyah").innerHTML = `
    <div class="question-text">Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentIndex + 1}: Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù€:</div>
    <div class="ayah-text">${q.ayanext}</div>
  `;
  
  const choices = [q.option1, q.option2, q.option3, q.option4];
  const correctIndex = parseInt(q["correct option number"]) - 1;
  const correctAnswer = choices[correctIndex];
  const shuffled = shuffleArray(choices);
  document.getElementById("choices").innerHTML = "";
  shuffled.forEach(choice => {
    const btn = document.createElement("button");
    btn.className = "option-btn";
    btn.innerText = choice;
    btn.onclick = () => checkNextAnswer(choice, correctAnswer, btn);
    document.getElementById("choices").appendChild(btn);
  });
}

function checkNextAnswer(selectedAnswer, correctAnswer, button) {
  userAnswers[currentIndex] = selectedAnswer;

  if (selectedAnswer === correctAnswer) {
    score++;
    button.className = "option-btn correct";
    document.getElementById("feedback").innerText = "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!";
    document.getElementById("feedback").className = "answer-feedback correct";
  } else {
    button.className = "option-btn wrong";
    document.getElementById("feedback").innerText = `âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctAnswer}`;
    document.getElementById("feedback").className = "answer-feedback wrong";
    corrections.push({
      question: `Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù€: 
      ${questions[currentIndex].ayanext}`,
      userAnswer: selectedAnswer,
      correctAnswer: correctAnswer
    });
  }
  setTimeout(() => {
    currentIndex++;
    showQuestion();
  }, 2000);
}

function storeResultInSheet() {
  const percentage = Math.round((score / questions.length) * 100);
  const correctCount = score;
  const wrongCount = questions.length - score;
  const data = {
    date: new Date().toLocaleString(),
    username: username,
    mode: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©",
    surah: selectedSurah === "__all__" ? "ÙƒÙ„ Ø§Ù„Ø³ÙˆØ±" : selectedSurah,
    questioncount: questions.length,
    score: Math.round((TOTAL_SCORE / questions.length) * score),
    correctCount: correctCount,
    wrongCount: wrongCount
  };
  fetch(sheetURLs.results, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  }).catch(e => console.error(e));
}

window.onload = function() {
  loadSurahs();

  document.getElementById('instructionsBtn').onclick = function() {
    document.getElementById('instructionsPage').style.display = 'block';
  };
  document.getElementById('backBtn').onclick = function() {
    document.getElementById('instructionsPage').style.display = 'none';
  };
};
</script>
</body>
</html>
